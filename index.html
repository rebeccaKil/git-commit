<!-- ====================================================================== -->
<!-- 파일 1: index.html (클라이언트 측 URL 파싱 오류 수정) -->
<!-- ====================================================================== -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 파일 커밋 자동화 도구 (편집 기능)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-input, #fileEditor { @apply w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200; }
        .btn { @apply w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 disabled:bg-gray-400; }
        .btn-secondary { @apply w-full px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-200; }
        .btn-edit { @apply w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-200 disabled:bg-gray-400; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #fileTree { max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem; }
        #fileTree ul { padding-left: 1rem; }
        #fileTree li { list-style: none; padding: 0.25rem 0; display: flex; align-items: center; }
        .tree-item { cursor: pointer; padding: 2px 4px; border-radius: 0.25rem; }
        .tree-item.selected { background-color: #dbeafe; }
        .folder::before { content: '▸ '; display: inline-block; transition: transform 0.2s; }
        .folder.open::before { transform: rotate(90deg); }
        .file::before { content: '📄'; margin-right: 6px; }
        .path-display { @apply mt-2 p-2 bg-gray-100 text-gray-800 rounded-md text-sm break-words; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-12">
    <div class="w-full max-w-2xl p-8 space-y-6 bg-white rounded-xl shadow-lg">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">GitHub 파일 자동화</h1>
            <p class="mt-2 text-gray-600">새 파일을 올리거나 기존 파일을 수정합니다.</p>
        </div>

        <form id="mainForm" class="space-y-6">
            <!-- 섹션 1: 저장소 정보 -->
            <div class="p-4 border rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">1. 대상 저장소 정보 입력</h2>
                <div class="space-y-4">
                    <div>
                        <label for="repoUrl" class="block text-sm font-medium text-gray-700">GitHub 저장소 URL</label>
                        <input type="url" id="repoUrl" required class="form-input mt-1" placeholder="https://github.com/owner/repository-name">
                    </div>
                    <div>
                        <label for="branchName" class="block text-sm font-medium text-gray-700">브랜치 이름 (기본: main)</label>
                        <input type="text" id="branchName" class="form-input mt-1" placeholder="비워두면 기본 브랜치 사용">
                    </div>
                    <button type="button" id="loadTreeBtn" class="btn-secondary">저장소 구조 불러오기</button>
                </div>
            </div>

            <!-- 섹션 2: 파일 탐색기 -->
            <div class="p-4 border rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">2. 파일 선택</h2>
                <p class="text-sm text-gray-600 mb-2">폴더를 클릭하면 새 파일 업로드 경로로 지정되고, 파일을 클릭하면 아래에 편집기가 나타납니다.</p>
                <div id="fileTree"></div>
                <div class="path-display">
                    <strong>선택된 경로:</strong> <span id="selectedPathDisplay">/</span>
                </div>
                <div id="treeLoader" class="text-center py-4 hidden"><div class="loader inline-block"></div></div>
            </div>

            <!-- ===== 신규 기능: 파일 편집기 ===== -->
            <div id="editorSection" class="p-4 border rounded-lg hidden">
                <h2 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">3. 파일 수정 및 커밋</h2>
                <p class="text-sm text-gray-600 mb-2">선택된 파일: <strong id="editingFileName"></strong></p>
                <textarea id="fileEditor" rows="15" class="font-mono text-sm"></textarea>
                <input type="hidden" id="fileSha">
                <input type="hidden" id="filePath">
                <div class="mt-4">
                    <label for="editCommitMessage" class="block text-sm font-medium text-gray-700">커밋 메시지</label>
                    <input type="text" id="editCommitMessage" required class="form-input mt-1" placeholder="fix: Update file content">
                </div>
                <button type="button" id="editCommitBtn" class="btn-edit mt-4 flex items-center justify-center">
                    <span id="editButtonText">파일 수정 커밋</span>
                    <div id="editLoader" class="loader hidden ml-3"></div>
                </button>
            </div>

            <!-- 섹션 4: 새 파일 업로드 -->
            <div class="p-4 border rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">3. 새 파일 업로드</h2>
                <div class="space-y-4">
                    <div>
                        <label for="fileInput" class="block text-sm font-medium text-gray-700">업로드할 파일 (여러 개 선택 가능)</label>
                        <input type="file" id="fileInput" multiple class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mt-1">
                    </div>
                    <div>
                        <label for="uploadCommitMessage" class="block text-sm font-medium text-gray-700">커밋 메시지</label>
                        <input type="text" id="uploadCommitMessage" class="form-input mt-1" placeholder="feat: Add new files">
                    </div>
                </div>
                 <button type="button" id="uploadCommitBtn" class="btn mt-4 flex items-center justify-center">
                    <span id="uploadButtonText">새 파일 업로드 커밋</span>
                    <div id="uploadLoader" class="loader hidden ml-3"></div>
                </button>
            </div>
        </form>
        <div id="status" class="mt-6 text-center text-sm"></div>
    </div>

    <script>
        // DOM 요소
        const mainForm = document.getElementById('mainForm');
        const statusDiv = document.getElementById('status');
        const loadTreeBtn = document.getElementById('loadTreeBtn');
        const fileTreeDiv = document.getElementById('fileTree');
        const treeLoader = document.getElementById('treeLoader');
        const selectedPathDisplay = document.getElementById('selectedPathDisplay');
        
        // 편집기 섹션
        const editorSection = document.getElementById('editorSection');
        const editingFileName = document.getElementById('editingFileName');
        const fileEditor = document.getElementById('fileEditor');
        const fileSha = document.getElementById('fileSha');
        const filePath = document.getElementById('filePath');
        const editCommitMessage = document.getElementById('editCommitMessage');
        const editCommitBtn = document.getElementById('editCommitBtn');
        const editButtonText = document.getElementById('editButtonText');
        const editLoader = document.getElementById('editLoader');

        // 업로드 섹션
        const fileInput = document.getElementById('fileInput');
        const uploadCommitMessage = document.getElementById('uploadCommitMessage');
        const uploadCommitBtn = document.getElementById('uploadCommitBtn');
        const uploadButtonText = document.getElementById('uploadButtonText');
        const uploadLoader = document.getElementById('uploadLoader');

        let owner, repo, uploadPath = '';

        // API 요청 헬퍼
        async function apiRequest(endpoint, options = {}) {
            // ===== 변경점: 상대 경로가 아닌 절대 경로로 URL을 명시적으로 생성하여 안정성 확보 =====
            const fullUrl = window.location.origin + endpoint;
            const response = await fetch(fullUrl, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API Error: ${response.status}. ${errorData.message || 'An error occurred.'}`);
            }
            return response.status === 204 ? null : response.json();
        }

        // 저장소 구조 불러오기
        loadTreeBtn.addEventListener('click', async () => {
            const repoUrl = document.getElementById('repoUrl').value;
            const branchName = document.getElementById('branchName').value.trim();
            if (!repoUrl) { showResult('저장소 URL을 먼저 입력해주세요.', 'error'); return; }

            try {
                const url = new URL(repoUrl);
                const pathParts = url.pathname.split('/').filter(p => p);
                if (url.hostname !== 'github.com' || pathParts.length < 2) throw new Error();
                [owner, repo] = pathParts;
            } catch (error) { showResult('올바른 GitHub 저장소 URL을 입력해주세요.', 'error'); return; }
            
            treeLoader.classList.remove('hidden');
            fileTreeDiv.innerHTML = '';
            editorSection.classList.add('hidden');

            try {
                const treeData = await apiRequest(`/api/commit?owner=${owner}&repo=${repo}&branch=${branchName}`);
                renderFileTree(treeData.tree);
            } catch (error) { showResult(`오류: ${error.message}`, 'error');
            } finally { treeLoader.classList.add('hidden'); }
        });

        // 파일 트리 렌더링
        function renderFileTree(tree) {
            const treeStructure = buildTree(tree);
            fileTreeDiv.innerHTML = '';
            const rootUl = createTreeHtml(treeStructure, '');
            fileTreeDiv.appendChild(rootUl);

            // 이벤트 위임 설정
            fileTreeDiv.addEventListener('click', (e) => {
                const target = e.target.closest('.tree-item');
                if (!target) return;

                document.querySelectorAll('.tree-item.selected').forEach(el => el.classList.remove('selected'));
                target.classList.add('selected');

                const path = target.dataset.path;
                const type = target.dataset.type;

                if (type === 'tree') {
                    uploadPath = path;
                    selectedPathDisplay.textContent = path === '' ? '/' : `/${path}`;
                    editorSection.classList.add('hidden');
                } else if (type === 'blob') {
                    uploadPath = path.substring(0, path.lastIndexOf('/'));
                    selectedPathDisplay.textContent = `/${uploadPath}`;
                    loadFileForEditing(path);
                }
            });
        }
        
        // 파일 트리 구조 생성
        function buildTree(tree) {
            const treeStructure = { name: repo, type: 'tree', children: {} };
            tree.forEach(item => {
                let currentLevel = treeStructure;
                const pathParts = item.path.split('/');
                pathParts.forEach((part, index) => {
                    if (!currentLevel.children[part]) {
                        currentLevel.children[part] = { name: part, children: {} };
                    }
                    if (index === pathParts.length - 1) {
                         currentLevel.children[part].type = item.type;
                         currentLevel.children[part].path = item.path;
                    }
                    currentLevel = currentLevel.children[part];
                });
            });
            return treeStructure;
        }

        // 파일 트리 HTML 생성
        function createTreeHtml(node, currentPath) {
            const ul = document.createElement('ul');
            if (currentPath !== '') ul.style.paddingLeft = '1rem';

            // 루트 노드 처리
            if(currentPath === '') {
                const rootLi = document.createElement('li');
                const rootSpan = document.createElement('span');
                rootSpan.textContent = node.name + ' (루트)';
                rootSpan.className = 'tree-item folder selected';
                rootSpan.dataset.path = '';
                rootSpan.dataset.type = 'tree';
                rootLi.appendChild(rootSpan);
                const childrenUl = createTreeHtml({children: node.children}, '');
                rootLi.appendChild(childrenUl);
                ul.appendChild(rootLi);
                return ul;
            }

            for (const key in node.children) {
                const childNode = node.children[key];
                const li = document.createElement('li');
                const span = document.createElement('span');
                span.textContent = childNode.name;
                span.className = `tree-item ${childNode.type === 'tree' ? 'folder' : 'file'}`;
                span.dataset.path = childNode.path;
                span.dataset.type = childNode.type;
                li.appendChild(span);

                if (childNode.type === 'tree' && Object.keys(childNode.children).length > 0) {
                    const subUl = createTreeHtml(childNode, childNode.path);
                    subUl.style.display = 'none'; // 기본적으로 닫힘
                    span.classList.add('open'); // 아이콘 표시용
                    span.addEventListener('click', (e) => {
                        if (e.target === span) {
                            span.classList.toggle('open');
                            subUl.style.display = subUl.style.display === 'none' ? 'block' : 'none';
                        }
                    }, true);
                    li.appendChild(subUl);
                }
                ul.appendChild(li);
            }
            return ul;
        }

        // 파일 내용 불러오기
        async function loadFileForEditing(path) {
            editingFileName.textContent = '불러오는 중...';
            editorSection.classList.remove('hidden');
            try {
                const branchName = document.getElementById('branchName').value.trim();
                const data = await apiRequest(`/api/commit?owner=${owner}&repo=${repo}&branch=${branchName}&path=${encodeURIComponent(path)}`);
                editingFileName.textContent = path;
                fileEditor.value = data.content;
                fileSha.value = data.sha;
                filePath.value = path;
                editCommitMessage.value = `Update ${path.split('/').pop()}`;
            } catch (error) {
                showResult(`파일 내용 불러오기 오류: ${error.message}`, 'error');
                editorSection.classList.add('hidden');
            }
        }

        // 파일 수정 커밋
        editCommitBtn.addEventListener('click', async () => {
            setLoadingState(true, 'edit');
            try {
                const result = await apiRequest('/api/commit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        owner, repo,
                        branch: document.getElementById('branchName').value.trim(),
                        commitMessage: editCommitMessage.value,
                        editedContent: fileEditor.value,
                        path: filePath.value,
                        sha: fileSha.value
                    })
                });
                showResult(`파일이 성공적으로 수정되었습니다! <a href="${result.commitUrl}" target="_blank" class="font-bold">새 커밋 보기</a>`, 'success');
                editorSection.classList.add('hidden');
            } catch (error) {
                showResult(`수정 커밋 오류: ${error.message}`, 'error');
            } finally {
                setLoadingState(false, 'edit');
            }
        });

        // 새 파일 업로드 커밋
        uploadCommitBtn.addEventListener('click', async () => {
            const files = fileInput.files;
            if (files.length === 0) { showResult('업로드할 파일을 선택해주세요.', 'error'); return; }
            if (!uploadCommitMessage.value) { showResult('커밋 메시지를 입력해주세요.', 'error'); return; }

            setLoadingState(true, 'upload');
            const filePromises = Array.from(files).map(file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({ name: file.name, content: reader.result.split(',')[1] });
                reader.onerror = reject;
            }));

            try {
                const filesAsBase64 = await Promise.all(filePromises);
                const result = await apiRequest('/api/commit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        owner, repo,
                        branch: document.getElementById('branchName').value.trim(),
                        commitMessage: uploadCommitMessage.value,
                        files: filesAsBase64,
                        path: uploadPath
                    })
                });
                showResult(`${files.length}개의 파일이 성공적으로 업로드되었습니다! <a href="${result.commitUrl}" target="_blank" class="font-bold">새 커밋 보기</a>`, 'success');
                fileInput.value = ''; // 입력 필드 초기화
            } catch (error) {
                showResult(`업로드 커밋 오류: ${error.message}`, 'error');
            } finally {
                setLoadingState(false, 'upload');
            }
        });

        // UI 상태 관리
        function showResult(message, type) {
            statusDiv.innerHTML = message;
            statusDiv.className = `mt-6 p-3 text-center text-sm rounded-lg ${ type === 'success' ? 'text-green-800 bg-green-100' : 'text-red-800 bg-red-100' }`;
        }
        function setLoadingState(isLoading, type) {
            const btnText = type === 'edit' ? editButtonText : uploadButtonText;
            const loader = type === 'edit' ? editLoader : uploadLoader;
            const button = type === 'edit' ? editCommitBtn : uploadCommitBtn;
            
            if (isLoading) {
                statusDiv.innerHTML = '';
                btnText.textContent = '처리 중...';
                loader.classList.remove('hidden');
                button.disabled = true;
            } else {
                btnText.textContent = type === 'edit' ? '파일 수정 커밋' : '새 파일 업로드 커밋';
                loader.classList.add('hidden');
                button.disabled = false;
            }
        }
    </script>
</body>
</html>
