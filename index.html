<!-- ====================================================================== -->
<!-- íŒŒì¼ 1: index.html (í´ë¼ì´ì–¸íŠ¸ ì¸¡ URL íŒŒì‹± ì˜¤ë¥˜ ìˆ˜ì •) -->
<!-- ====================================================================== -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub íŒŒì¼ ì»¤ë°‹ ìë™í™” ë„êµ¬ (í¸ì§‘ ê¸°ëŠ¥)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-input, #fileEditor { @apply w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200; }
        .btn { @apply w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 disabled:bg-gray-400; }
        .btn-secondary { @apply w-full px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-200; }
        .btn-edit { @apply w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-200 disabled:bg-gray-400; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #fileTree { max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem; }
        #fileTree ul { padding-left: 1rem; }
        #fileTree li { list-style: none; padding: 0.25rem 0; display: flex; align-items: center; }
        .tree-item { cursor: pointer; padding: 2px 4px; border-radius: 0.25rem; }
        .tree-item.selected { background-color: #dbeafe; }
        .folder::before { content: 'â–¸ '; display: inline-block; transition: transform 0.2s; }
        .folder.open::before { transform: rotate(90deg); }
        .file::before { content: 'ğŸ“„'; margin-right: 6px; }
        .path-display { @apply mt-2 p-2 bg-gray-100 text-gray-800 rounded-md text-sm break-words; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-12">
    <div class="w-full max-w-2xl p-8 space-y-6 bg-white rounded-xl shadow-lg">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">GitHub íŒŒì¼ ìë™í™”</h1>
            <p class="mt-2 text-gray-600">ìƒˆ íŒŒì¼ì„ ì˜¬ë¦¬ê±°ë‚˜ ê¸°ì¡´ íŒŒì¼ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.</p>
        </div>

        <form id="mainForm" class="space-y-6">
            <!-- ì„¹ì…˜ 1: ì €ì¥ì†Œ ì •ë³´ -->
            <div class="p-4 border rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">1. ëŒ€ìƒ ì €ì¥ì†Œ ì •ë³´ ì…ë ¥</h2>
                <div class="space-y-4">
                    <div>
                        <label for="repoUrl" class="block text-sm font-medium text-gray-700">GitHub ì €ì¥ì†Œ URL</label>
                        <input type="url" id="repoUrl" required class="form-input mt-1" placeholder="https://github.com/owner/repository-name">
                    </div>
                    <div>
                        <label for="branchName" class="block text-sm font-medium text-gray-700">ë¸Œëœì¹˜ ì´ë¦„ (ê¸°ë³¸: main)</label>
                        <input type="text" id="branchName" class="form-input mt-1" placeholder="ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ë¸Œëœì¹˜ ì‚¬ìš©">
                    </div>
                    <button type="button" id="loadTreeBtn" class="btn-secondary">ì €ì¥ì†Œ êµ¬ì¡° ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
            </div>

            <!-- ì„¹ì…˜ 2: íŒŒì¼ íƒìƒ‰ê¸° -->
            <div class="p-4 border rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">2. íŒŒì¼ ì„ íƒ</h2>
                <p class="text-sm text-gray-600 mb-2">í´ë”ë¥¼ í´ë¦­í•˜ë©´ ìƒˆ íŒŒì¼ ì—…ë¡œë“œ ê²½ë¡œë¡œ ì§€ì •ë˜ê³ , íŒŒì¼ì„ í´ë¦­í•˜ë©´ ì•„ë˜ì— í¸ì§‘ê¸°ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                <div id="fileTree"></div>
                <div class="path-display">
                    <strong>ì„ íƒëœ ê²½ë¡œ:</strong> <span id="selectedPathDisplay">/</span>
                </div>
                <div id="treeLoader" class="text-center py-4 hidden"><div class="loader inline-block"></div></div>
            </div>

            <!-- ===== ì‹ ê·œ ê¸°ëŠ¥: íŒŒì¼ í¸ì§‘ê¸° ===== -->
            <div id="editorSection" class="p-4 border rounded-lg hidden">
                <h2 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">3. íŒŒì¼ ìˆ˜ì • ë° ì»¤ë°‹</h2>
                <p class="text-sm text-gray-600 mb-2">ì„ íƒëœ íŒŒì¼: <strong id="editingFileName"></strong></p>
                <textarea id="fileEditor" rows="15" class="font-mono text-sm"></textarea>
                <input type="hidden" id="fileSha">
                <input type="hidden" id="filePath">
                <div class="mt-4">
                    <label for="editCommitMessage" class="block text-sm font-medium text-gray-700">ì»¤ë°‹ ë©”ì‹œì§€</label>
                    <input type="text" id="editCommitMessage" required class="form-input mt-1" placeholder="fix: Update file content">
                </div>
                <button type="button" id="editCommitBtn" class="btn-edit mt-4 flex items-center justify-center">
                    <span id="editButtonText">íŒŒì¼ ìˆ˜ì • ì»¤ë°‹</span>
                    <div id="editLoader" class="loader hidden ml-3"></div>
                </button>
            </div>

            <!-- ì„¹ì…˜ 4: ìƒˆ íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="p-4 border rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">3. ìƒˆ íŒŒì¼ ì—…ë¡œë“œ</h2>
                <div class="space-y-4">
                    <div>
                        <label for="fileInput" class="block text-sm font-medium text-gray-700">ì—…ë¡œë“œí•  íŒŒì¼ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</label>
                        <input type="file" id="fileInput" multiple class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mt-1">
                    </div>
                    <div>
                        <label for="uploadCommitMessage" class="block text-sm font-medium text-gray-700">ì»¤ë°‹ ë©”ì‹œì§€</label>
                        <input type="text" id="uploadCommitMessage" class="form-input mt-1" placeholder="feat: Add new files">
                    </div>
                </div>
                 <button type="button" id="uploadCommitBtn" class="btn mt-4 flex items-center justify-center">
                    <span id="uploadButtonText">ìƒˆ íŒŒì¼ ì—…ë¡œë“œ ì»¤ë°‹</span>
                    <div id="uploadLoader" class="loader hidden ml-3"></div>
                </button>
            </div>
        </form>
        <div id="status" class="mt-6 text-center text-sm"></div>
    </div>

    <script>
        // DOM ìš”ì†Œ
        const mainForm = document.getElementById('mainForm');
        const statusDiv = document.getElementById('status');
        const loadTreeBtn = document.getElementById('loadTreeBtn');
        const fileTreeDiv = document.getElementById('fileTree');
        const treeLoader = document.getElementById('treeLoader');
        const selectedPathDisplay = document.getElementById('selectedPathDisplay');
        
        // í¸ì§‘ê¸° ì„¹ì…˜
        const editorSection = document.getElementById('editorSection');
        const editingFileName = document.getElementById('editingFileName');
        const fileEditor = document.getElementById('fileEditor');
        const fileSha = document.getElementById('fileSha');
        const filePath = document.getElementById('filePath');
        const editCommitMessage = document.getElementById('editCommitMessage');
        const editCommitBtn = document.getElementById('editCommitBtn');
        const editButtonText = document.getElementById('editButtonText');
        const editLoader = document.getElementById('editLoader');

        // ì—…ë¡œë“œ ì„¹ì…˜
        const fileInput = document.getElementById('fileInput');
        const uploadCommitMessage = document.getElementById('uploadCommitMessage');
        const uploadCommitBtn = document.getElementById('uploadCommitBtn');
        const uploadButtonText = document.getElementById('uploadButtonText');
        const uploadLoader = document.getElementById('uploadLoader');

        let owner, repo, uploadPath = '';

        // API ìš”ì²­ í—¬í¼
        async function apiRequest(endpoint, options = {}) {
            // ===== ë³€ê²½ì : ìƒëŒ€ ê²½ë¡œê°€ ì•„ë‹Œ ì ˆëŒ€ ê²½ë¡œë¡œ URLì„ ëª…ì‹œì ìœ¼ë¡œ ìƒì„±í•˜ì—¬ ì•ˆì •ì„± í™•ë³´ =====
            const fullUrl = window.location.origin + endpoint;
            const response = await fetch(fullUrl, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API Error: ${response.status}. ${errorData.message || 'An error occurred.'}`);
            }
            return response.status === 204 ? null : response.json();
        }

        // ì €ì¥ì†Œ êµ¬ì¡° ë¶ˆëŸ¬ì˜¤ê¸°
        loadTreeBtn.addEventListener('click', async () => {
            const repoUrl = document.getElementById('repoUrl').value;
            const branchName = document.getElementById('branchName').value.trim();
            if (!repoUrl) { showResult('ì €ì¥ì†Œ URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }

            try {
                const url = new URL(repoUrl);
                const pathParts = url.pathname.split('/').filter(p => p);
                if (url.hostname !== 'github.com' || pathParts.length < 2) throw new Error();
                [owner, repo] = pathParts;
            } catch (error) { showResult('ì˜¬ë°”ë¥¸ GitHub ì €ì¥ì†Œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
            
            treeLoader.classList.remove('hidden');
            fileTreeDiv.innerHTML = '';
            editorSection.classList.add('hidden');

            try {
                const treeData = await apiRequest(`/api/commit?owner=${owner}&repo=${repo}&branch=${branchName}`);
                renderFileTree(treeData.tree);
            } catch (error) { showResult(`ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally { treeLoader.classList.add('hidden'); }
        });

        // íŒŒì¼ íŠ¸ë¦¬ ë Œë”ë§
        function renderFileTree(tree) {
            const treeStructure = buildTree(tree);
            fileTreeDiv.innerHTML = '';
            const rootUl = createTreeHtml(treeStructure, '');
            fileTreeDiv.appendChild(rootUl);

            // ì´ë²¤íŠ¸ ìœ„ì„ ì„¤ì •
            fileTreeDiv.addEventListener('click', (e) => {
                const target = e.target.closest('.tree-item');
                if (!target) return;

                document.querySelectorAll('.tree-item.selected').forEach(el => el.classList.remove('selected'));
                target.classList.add('selected');

                const path = target.dataset.path;
                const type = target.dataset.type;

                if (type === 'tree') {
                    uploadPath = path;
                    selectedPathDisplay.textContent = path === '' ? '/' : `/${path}`;
                    editorSection.classList.add('hidden');
                } else if (type === 'blob') {
                    uploadPath = path.substring(0, path.lastIndexOf('/'));
                    selectedPathDisplay.textContent = `/${uploadPath}`;
                    loadFileForEditing(path);
                }
            });
        }
        
        // íŒŒì¼ íŠ¸ë¦¬ êµ¬ì¡° ìƒì„±
        function buildTree(tree) {
            const treeStructure = { name: repo, type: 'tree', children: {} };
            tree.forEach(item => {
                let currentLevel = treeStructure;
                const pathParts = item.path.split('/');
                pathParts.forEach((part, index) => {
                    if (!currentLevel.children[part]) {
                        currentLevel.children[part] = { name: part, children: {} };
                    }
                    if (index === pathParts.length - 1) {
                         currentLevel.children[part].type = item.type;
                         currentLevel.children[part].path = item.path;
                    }
                    currentLevel = currentLevel.children[part];
                });
            });
            return treeStructure;
        }

        // íŒŒì¼ íŠ¸ë¦¬ HTML ìƒì„±
        function createTreeHtml(node, currentPath) {
            const ul = document.createElement('ul');
            if (currentPath !== '') ul.style.paddingLeft = '1rem';

            // ë£¨íŠ¸ ë…¸ë“œ ì²˜ë¦¬
            if(currentPath === '') {
                const rootLi = document.createElement('li');
                const rootSpan = document.createElement('span');
                rootSpan.textContent = node.name + ' (ë£¨íŠ¸)';
                rootSpan.className = 'tree-item folder selected';
                rootSpan.dataset.path = '';
                rootSpan.dataset.type = 'tree';
                rootLi.appendChild(rootSpan);
                const childrenUl = createTreeHtml({children: node.children}, '');
                rootLi.appendChild(childrenUl);
                ul.appendChild(rootLi);
                return ul;
            }

            for (const key in node.children) {
                const childNode = node.children[key];
                const li = document.createElement('li');
                const span = document.createElement('span');
                span.textContent = childNode.name;
                span.className = `tree-item ${childNode.type === 'tree' ? 'folder' : 'file'}`;
                span.dataset.path = childNode.path;
                span.dataset.type = childNode.type;
                li.appendChild(span);

                if (childNode.type === 'tree' && Object.keys(childNode.children).length > 0) {
                    const subUl = createTreeHtml(childNode, childNode.path);
                    subUl.style.display = 'none'; // ê¸°ë³¸ì ìœ¼ë¡œ ë‹«í˜
                    span.classList.add('open'); // ì•„ì´ì½˜ í‘œì‹œìš©
                    span.addEventListener('click', (e) => {
                        if (e.target === span) {
                            span.classList.toggle('open');
                            subUl.style.display = subUl.style.display === 'none' ? 'block' : 'none';
                        }
                    }, true);
                    li.appendChild(subUl);
                }
                ul.appendChild(li);
            }
            return ul;
        }

        // íŒŒì¼ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadFileForEditing(path) {
            editingFileName.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            editorSection.classList.remove('hidden');
            try {
                const branchName = document.getElementById('branchName').value.trim();
                const data = await apiRequest(`/api/commit?owner=${owner}&repo=${repo}&branch=${branchName}&path=${encodeURIComponent(path)}`);
                editingFileName.textContent = path;
                fileEditor.value = data.content;
                fileSha.value = data.sha;
                filePath.value = path;
                editCommitMessage.value = `Update ${path.split('/').pop()}`;
            } catch (error) {
                showResult(`íŒŒì¼ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${error.message}`, 'error');
                editorSection.classList.add('hidden');
            }
        }

        // íŒŒì¼ ìˆ˜ì • ì»¤ë°‹
        editCommitBtn.addEventListener('click', async () => {
            setLoadingState(true, 'edit');
            try {
                const result = await apiRequest('/api/commit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        owner, repo,
                        branch: document.getElementById('branchName').value.trim(),
                        commitMessage: editCommitMessage.value,
                        editedContent: fileEditor.value,
                        path: filePath.value,
                        sha: fileSha.value
                    })
                });
                showResult(`íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! <a href="${result.commitUrl}" target="_blank" class="font-bold">ìƒˆ ì»¤ë°‹ ë³´ê¸°</a>`, 'success');
                editorSection.classList.add('hidden');
            } catch (error) {
                showResult(`ìˆ˜ì • ì»¤ë°‹ ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                setLoadingState(false, 'edit');
            }
        });

        // ìƒˆ íŒŒì¼ ì—…ë¡œë“œ ì»¤ë°‹
        uploadCommitBtn.addEventListener('click', async () => {
            const files = fileInput.files;
            if (files.length === 0) { showResult('ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error'); return; }
            if (!uploadCommitMessage.value) { showResult('ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }

            setLoadingState(true, 'upload');
            const filePromises = Array.from(files).map(file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({ name: file.name, content: reader.result.split(',')[1] });
                reader.onerror = reject;
            }));

            try {
                const filesAsBase64 = await Promise.all(filePromises);
                const result = await apiRequest('/api/commit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        owner, repo,
                        branch: document.getElementById('branchName').value.trim(),
                        commitMessage: uploadCommitMessage.value,
                        files: filesAsBase64,
                        path: uploadPath
                    })
                });
                showResult(`${files.length}ê°œì˜ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! <a href="${result.commitUrl}" target="_blank" class="font-bold">ìƒˆ ì»¤ë°‹ ë³´ê¸°</a>`, 'success');
                fileInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            } catch (error) {
                showResult(`ì—…ë¡œë“œ ì»¤ë°‹ ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                setLoadingState(false, 'upload');
            }
        });

        // UI ìƒíƒœ ê´€ë¦¬
        function showResult(message, type) {
            statusDiv.innerHTML = message;
            statusDiv.className = `mt-6 p-3 text-center text-sm rounded-lg ${ type === 'success' ? 'text-green-800 bg-green-100' : 'text-red-800 bg-red-100' }`;
        }
        function setLoadingState(isLoading, type) {
            const btnText = type === 'edit' ? editButtonText : uploadButtonText;
            const loader = type === 'edit' ? editLoader : uploadLoader;
            const button = type === 'edit' ? editCommitBtn : uploadCommitBtn;
            
            if (isLoading) {
                statusDiv.innerHTML = '';
                btnText.textContent = 'ì²˜ë¦¬ ì¤‘...';
                loader.classList.remove('hidden');
                button.disabled = true;
            } else {
                btnText.textContent = type === 'edit' ? 'íŒŒì¼ ìˆ˜ì • ì»¤ë°‹' : 'ìƒˆ íŒŒì¼ ì—…ë¡œë“œ ì»¤ë°‹';
                loader.classList.add('hidden');
                button.disabled = false;
            }
        }
    </script>
</body>
</html>
